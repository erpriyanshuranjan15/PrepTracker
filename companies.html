<!DOCTYPE html>
<html lang="en">
<head>
<script src="auth.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrepTracker ‚Äì Companies</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<nav class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">PT</div>
    <span class="logo-text">PrepTracker</span>
  </div>
  <ul class="nav-links">
    <li><a href="index.html" class="nav-item"><span class="nav-icon">‚¨°</span><span>Dashboard</span></a></li>
    <li><a href="skills.html" class="nav-item"><span class="nav-icon">‚óà</span><span>Skills</span></a></li>
    <li><a href="goals.html" class="nav-item"><span class="nav-icon">‚óé</span><span>Daily Goals</span></a></li>
    <li><a href="companies.html" class="nav-item active"><span class="nav-icon">‚ó∑</span><span>Companies</span></a></li>
    <li><a href="resume.html" class="nav-item"><span class="nav-icon">‚óª</span><span>Resume</span></a></li>
    <li><a href="notes.html" class="nav-item"><span class="nav-icon">‚óà</span><span>Notes</span></a></li>
  </ul>
  <div class="sidebar-footer" style="flex-direction:column;align-items:flex-start;gap:8px">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="user-avatar">AS</div>
      <div class="user-info">
        <span class="user-name">Aryan Singh</span>
        <span class="user-role">B.Tech CSE ¬∑ 2025</span>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">‚éã Sign Out</button>
  </div>
</nav>

<main class="main-content">
  <header class="top-header">
    <div class="header-left">
      <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <div>
        <h1 class="page-title">Company Pipeline</h1>
        <p class="page-sub">Track your placement journey, company by company</p>
      </div>
    </div>
    <div class="header-right">
      <button class="btn-primary" onclick="openModal()">+ Add Company</button>
    </div>
  </header>

  <!-- Pipeline Stats -->
  <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:28px;">
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(197,157,217,0.15)">üè¢</div>
      <div class="stat-val">9</div>
      <div class="stat-lbl">Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(232,195,106,0.2)">üìã</div>
      <div class="stat-val">3</div>
      <div class="stat-lbl">Preparing</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(106,171,223,0.2)">üì®</div>
      <div class="stat-val">3</div>
      <div class="stat-lbl">Applied</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(94,206,160,0.2)">üéØ</div>
      <div class="stat-val">2</div>
      <div class="stat-lbl">Interviews</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:rgba(155,89,201,0.3)">üéâ</div>
      <div class="stat-val">1</div>
      <div class="stat-lbl">Offers</div>
    </div>
  </div>

  <!-- Pipeline Funnel + Pie -->
  <div style="display:grid;grid-template-columns:1.5fr 1fr;gap:20px;margin-bottom:28px;">
    <div class="chart-card">
      <div class="chart-header">
        <h3>Application Funnel</h3>
      </div>
      <canvas id="funnelChart" height="140"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-header">
        <h3>Status Distribution</h3>
      </div>
      <canvas id="pipelinePie" height="180"></canvas>
    </div>
  </div>

  <!-- Company Cards -->
  <div class="company-grid" id="company-grid"></div>
</main>

<!-- Company Detail Panel -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal" style="width:560px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <div class="modal-title" id="detail-name">Google</div>
      <button onclick="closeDetail()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:20px">‚úï</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
      <div>
        <div class="form-label">Role</div>
        <div id="detail-role" style="font-size:14px;font-weight:600"></div>
      </div>
      <div>
        <div class="form-label">Status</div>
        <div id="detail-status"></div>
      </div>
    </div>
    <div class="form-group">
      <div class="form-label">Preparation Progress</div>
      <div style="height:8px;background:var(--surface2);border-radius:8px;overflow:hidden;margin-top:6px;">
        <div id="detail-bar" style="height:100%;background:var(--amethyst);border-radius:8px;transition:width 0.5s"></div>
      </div>
      <div style="text-align:right;font-size:12px;color:var(--lilac);margin-top:4px" id="detail-pct"></div>
    </div>
    <div class="form-group">
      <div class="form-label">Notes</div>
      <textarea class="form-textarea" id="detail-notes" placeholder="Add preparation notes for this company..."></textarea>
    </div>
    <div class="form-group">
      <div class="form-label">Focus Topics</div>
      <div id="detail-topics" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeDetail()">Close</button>
      <button class="btn-primary">Save Notes</button>
    </div>
  </div>
</div>

<!-- Add Company Modal -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div class="modal-title">Add Company</div>
    <div class="form-group">
      <label class="form-label">Company Name</label>
      <input type="text" class="form-input" id="co-name" placeholder="e.g., Google">
    </div>
    <div class="form-group">
      <label class="form-label">Role</label>
      <input type="text" class="form-input" id="co-role" placeholder="e.g., SDE-1">
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <select class="form-select" id="co-status">
        <option value="prep">Preparing</option>
        <option value="applied">Applied</option>
        <option value="interview">Interview</option>
        <option value="offer">Offer</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="document.getElementById('add-modal').classList.remove('open')">Cancel</button>
      <button class="btn-primary" onclick="addCompany()">Add</button>
    </div>
  </div>
</div>

<script>
const CO_API = '/api/companies';
let companies = [];

async function loadCompanies() {
  const res = await fetch(CO_API);
  companies = await res.json();
  renderCompanies();
}

const bgAlpha = c => c + '22';

function renderCompanies() {
  const grid = document.getElementById('company-grid');
  grid.innerHTML = companies.map((c, i) => `
    <div class="company-card" onclick="showDetail(${i})">
      <div class="co-card-header">
        <div class="co-big-logo" style="background:${bgAlpha(c.color)};color:${c.color}">${c.emoji}</div>
        <div>
          <div class="co-card-name">${c.name}</div>
          <div class="co-card-role">${c.role}</div>
        </div>
        <div style="margin-left:auto"><span class="co-status status-${c.status}">${c.status.charAt(0).toUpperCase()+c.status.slice(1)}</span></div>
      </div>
      <div class="co-prep-bar">
        <div class="co-prep-label"><span>Prep Progress</span><span>${c.prep}%</span></div>
        <div class="skill-bar-bg">
          <div class="skill-bar-fill" style="width:${c.prep}%;background:${c.color}"></div>
        </div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:12px;">
        ${(c.topics||[]).map(t => `<span class="pill" style="background:${bgAlpha(c.color)};color:${c.color};border:1px solid ${c.color}44;font-size:10px">${t}</span>`).join('')}
      </div>
      ${c.notes ? `<div class="co-notes">${c.notes}</div>` : ''}
    </div>
  `).join('');
}

function showDetail(i) {
  const c = companies[i];
  document.getElementById('detail-name').textContent = c.name;
  document.getElementById('detail-role').textContent = c.role;
  document.getElementById('detail-status').innerHTML = `<span class="co-status status-${c.status}">${c.status}</span>`;
  document.getElementById('detail-bar').style.width = c.prep + '%';
  document.getElementById('detail-pct').textContent = c.prep + '%';
  document.getElementById('detail-notes').value = c.notes;
  document.getElementById('detail-topics').innerHTML = (c.topics||[]).map(t =>
    `<span class="pill" style="background:${c.color}22;color:${c.color};border:1px solid ${c.color}44;font-size:11px">${t}</span>`
  ).join('');
  document.getElementById('detail-modal').classList.add('open');
}

function closeDetail() { document.getElementById('detail-modal').classList.remove('open'); }
function openModal() { document.getElementById('add-modal').classList.add('open'); }

async function addCompany() {
  const name = document.getElementById('co-name').value;
  const role = document.getElementById('co-role').value;
  const status = document.getElementById('co-status').value;
  if (!name) return;
  const res = await fetch(CO_API, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ name, role, status })
  });
  const co = await res.json();
  companies.push(co);
  renderCompanies();
  document.getElementById('add-modal').classList.remove('open');
}

loadCompanies();

// Funnel
new Chart(document.getElementById('funnelChart'), {
  type: 'bar',
  data: {
    labels: ['Preparing','Applied','Interview','Offer'],
    datasets: [{
      data: [3, 3, 2, 1],
      backgroundColor: ['#E8C36A','#6AABDF','#5ECEA0','#C59DD9'],
      borderRadius: 8,
      borderSkipped: false
    }]
  },
  options: {
    indexAxis: 'y',
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { color: 'rgba(197,157,217,0.08)' }, ticks: { color: 'rgba(197,157,217,0.45)' } },
      y: { grid: { display: false }, ticks: { color: '#C59DD9' } }
    }
  }
});

new Chart(document.getElementById('pipelinePie'), {
  type: 'pie',
  data: {
    labels: ['Preparing','Applied','Interview','Offer'],
    datasets: [{ data: [3,3,2,1], backgroundColor: ['#E8C36A','#6AABDF','#5ECEA0','#C59DD9'], borderWidth: 2, borderColor: '#1A0828' }]
  },
  options: { plugins: { legend: { position: 'bottom', labels: { color: '#C59DD9', boxWidth: 12, padding: 8 } } } }
});
</script>
<script src="theme-switcher.js"></script>
</body>
</html>